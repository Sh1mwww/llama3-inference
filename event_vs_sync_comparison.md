# Event å¼‚æ­¥åŒæ­¥ vs æ˜¾å¼åŒæ­¥æ–¹æ³•å¯¹æ¯”

## ä¸€ã€ä»£ç å¯¹æ¯”

### æ–¹æ³• 1: Event å¼‚æ­¥åŒæ­¥ (å½“å‰å®ç°ï¼Œæ¨è)

```python
# ============================================================
# æ–¹æ³• 1: ä½¿ç”¨ Event å®ç°å¼‚æ­¥æµæ°´çº¿
# ============================================================

import torch

# === åˆå§‹åŒ–æµ ===
streams = {
    'weight_h2d_mha': torch.cuda.Stream(priority=-1),  # é«˜ä¼˜å…ˆçº§
    'compute_mha':    torch.cuda.Stream(priority=-1),
    'weight_h2d_ffn': torch.cuda.Stream(priority=0),   # æ™®é€šä¼˜å…ˆçº§
    'compute_ffn':    torch.cuda.Stream(priority=0),
}

# === Layer 0 å¤„ç† ===
def process_layer_0_async():
    # Step 1: åœ¨ H2D æµä¸Šå¼‚æ­¥ä¼ è¾“ MHA æƒé‡
    with torch.cuda.stream(streams['weight_h2d_mha']):
        mha_weights_gpu = mha_weights_cpu.to('cuda', non_blocking=True)
        # â†‘ CPU è€—æ—¶: ~0.01ms (ç«‹å³è¿”å›)
        # â†“ GPU è€—æ—¶: 6.74ms (åå°æ‰§è¡Œ)

    # Step 2: è®°å½• Event (æ ‡è®° H2D å®Œæˆç‚¹)
    mha_h2d_event = torch.cuda.Event()
    mha_h2d_event.record(streams['weight_h2d_mha'])
    # â†‘ CPU è€—æ—¶: ~0.001ms (ç«‹å³è¿”å›)

    # Step 3: è®¡ç®—æµç­‰å¾… Event
    streams['compute_mha'].wait_event(mha_h2d_event)
    # â†‘ CPU è€—æ—¶: ~0.001ms (ç«‹å³è¿”å›)
    # â†“ GPU ä¼šåœ¨ç¡¬ä»¶å±‚é¢ç­‰å¾…ï¼Œä¸å  CPU

    # Step 4: åœ¨è®¡ç®—æµä¸Šæ‰§è¡Œ MHA (ä¸ FFN æƒé‡ä¼ è¾“å¹¶è¡Œ)
    with torch.cuda.stream(streams['compute_mha']):
        out_mha = attention(q, k, v, mha_weights_gpu)
        # â†‘ CPU è€—æ—¶: ~0.01ms (æäº¤ kernel)
        # â†“ GPU è€—æ—¶: 152.42ms (åå°æ‰§è¡Œ)

    # Step 5: å¹¶è¡Œä¼ è¾“ FFN æƒé‡ (åœ¨ MHA è®¡ç®—æœŸé—´)
    with torch.cuda.stream(streams['weight_h2d_ffn']):
        ffn_weights_gpu = ffn_weights_cpu.to('cuda', non_blocking=True)
        # â†‘ ä¸ MHA è®¡ç®—å¹¶è¡Œï¼CPU ç«‹å³è¿”å›

    ffn_h2d_event = torch.cuda.Event()
    ffn_h2d_event.record(streams['weight_h2d_ffn'])

    # Step 6: FFN è®¡ç®—ç­‰å¾…æƒé‡
    streams['compute_ffn'].wait_event(ffn_h2d_event)

    with torch.cuda.stream(streams['compute_ffn']):
        out_ffn = ffn(out_mha, ffn_weights_gpu)
        # â†‘ GPU è€—æ—¶: 25.94ms

    # Step 7: CPU ç»§ç»­é¢„å– Layer 1 æƒé‡ (ä¸ FFN è®¡ç®—å¹¶è¡Œ)
    with torch.cuda.stream(streams['weight_h2d_mha']):
        layer1_weights = layer1_cpu.to('cuda', non_blocking=True)

    return out_ffn  # CPU ç«‹å³è¿”å›ï¼ŒGPU åå°æ‰§è¡Œ


# === CPU æ—¶é—´çº¿ ===
# 0.000ms: æäº¤ MHA H2D
# 0.010ms: record(mha_h2d_event)
# 0.011ms: wait_event(mha_h2d_event)
# 0.012ms: æäº¤ MHA kernel
# 0.022ms: æäº¤ FFN H2D
# 0.032ms: record(ffn_h2d_event)
# 0.033ms: wait_event(ffn_h2d_event)
# 0.044ms: æäº¤ FFN kernel
# 0.054ms: æäº¤ Layer1 H2D
# 0.064ms: return  â† CPU å®Œæˆï¼Œç»§ç»­å¤„ç†å…¶ä»–ä»»åŠ¡
#
# **CPU æ€»è€—æ—¶: 0.064ms**
# **CPU åˆ©ç”¨ç‡: 100% (å§‹ç»ˆåœ¨æäº¤ä»»åŠ¡)**
```

---

### æ–¹æ³• 2: æ˜¾å¼åŒæ­¥ (é”™è¯¯æ–¹æ³•ï¼Œæ€§èƒ½å·®)

```python
# ============================================================
# æ–¹æ³• 2: ä½¿ç”¨ synchronize() æ˜¾å¼åŒæ­¥ (ä¸²è¡Œæ‰§è¡Œ)
# ============================================================

import torch

# === åªä½¿ç”¨é»˜è®¤æµ (å•æµ) ===
# æ— éœ€åˆ›å»ºé¢å¤–çš„æµ

# === Layer 0 å¤„ç† ===
def process_layer_0_sync():
    # Step 1: ä¼ è¾“ MHA æƒé‡ (é˜»å¡ä¼ è¾“)
    mha_weights_gpu = mha_weights_cpu.to('cuda', non_blocking=False)
    # â†‘ CPU è€—æ—¶: 6.74ms (é˜»å¡ç­‰å¾…)
    # â†“ GPU è€—æ—¶: 6.74ms

    # æˆ–è€…ç”¨å¼‚æ­¥ä¼ è¾“ + synchronize (æ•ˆæœç›¸åŒ)
    # mha_weights_gpu = mha_weights_cpu.to('cuda', non_blocking=True)
    # torch.cuda.synchronize()  # â† é˜»å¡ CPU 6.74ms

    # Step 2: æ‰§è¡Œ MHA è®¡ç®—
    out_mha = attention(q, k, v, mha_weights_gpu)
    # â†‘ CPU è€—æ—¶: ~0.01ms (æäº¤ kernel)
    # â†“ GPU è€—æ—¶: 152.42ms

    # Step 3: ç­‰å¾… MHA å®Œæˆ (å¿…é¡»ï¼Œå¦åˆ™æ— æ³•å¼€å§‹ FFN H2D)
    torch.cuda.synchronize()
    # â†‘ CPU è€—æ—¶: 152.42ms (é˜»å¡ç­‰å¾…)

    # Step 4: ä¼ è¾“ FFN æƒé‡ (å¿…é¡»ç­‰ MHA å®Œæˆ)
    ffn_weights_gpu = ffn_weights_cpu.to('cuda', non_blocking=False)
    # â†‘ CPU è€—æ—¶: 13.54ms (é˜»å¡ç­‰å¾…)
    # â†“ GPU è€—æ—¶: 13.54ms

    # Step 5: æ‰§è¡Œ FFN è®¡ç®—
    out_ffn = ffn(out_mha, ffn_weights_gpu)
    # â†‘ CPU è€—æ—¶: ~0.01ms
    # â†“ GPU è€—æ—¶: 25.94ms

    # Step 6: ç­‰å¾… FFN å®Œæˆ
    torch.cuda.synchronize()
    # â†‘ CPU è€—æ—¶: 25.94ms (é˜»å¡ç­‰å¾…)

    # Step 7: ä¼ è¾“ Layer 1 æƒé‡ (å¿…é¡»ç­‰ FFN å®Œæˆ)
    layer1_weights = layer1_cpu.to('cuda', non_blocking=False)
    # â†‘ CPU è€—æ—¶: 6.74ms (é˜»å¡ç­‰å¾…)

    return out_ffn  # CPU åœ¨è¿™é‡Œæ‰çœŸæ­£å®Œæˆ


# === CPU æ—¶é—´çº¿ ===
# 0.00ms:   å¼€å§‹ MHA H2D
# 6.74ms:   MHA H2D å®Œæˆ â† CPU é˜»å¡ç­‰å¾…
# 6.75ms:   æäº¤ MHA kernel
# 159.17ms: MHA å®Œæˆ â† CPU é˜»å¡ç­‰å¾…
# 159.18ms: å¼€å§‹ FFN H2D
# 172.72ms: FFN H2D å®Œæˆ â† CPU é˜»å¡ç­‰å¾…
# 172.73ms: æäº¤ FFN kernel
# 198.67ms: FFN å®Œæˆ â† CPU é˜»å¡ç­‰å¾…
# 198.68ms: å¼€å§‹ Layer1 H2D
# 205.42ms: Layer1 H2D å®Œæˆ â† CPU é˜»å¡ç­‰å¾…
# 205.42ms: return
#
# **CPU æ€»è€—æ—¶: 205.42ms**
# **CPU åˆ©ç”¨ç‡: ~0.3% (å¤§éƒ¨åˆ†æ—¶é—´åœ¨ç­‰å¾… GPU)**
```

---

## äºŒã€æ—¶é—´çº¿å¯¹æ¯”å›¾

### æ–¹æ³• 1: Event å¼‚æ­¥ (å¤šæµå¹¶è¡Œ)

```
æ—¶é—´ â†’  0ms      50ms     100ms    150ms    200ms    250ms
        â”‚        â”‚        â”‚        â”‚        â”‚        â”‚

CPU     â”œâ”€â”€â”€â”€â”  (ç«‹å³è¿”å›ï¼Œç»§ç»­å¤„ç†å…¶ä»–ä»»åŠ¡)
çº¿ç¨‹    â”‚æäº¤â”‚
        â””â”€â”€â”€â”€â”˜
        0.064ms æ€»è€—æ—¶
        â†‘ CPU 100% åˆ©ç”¨ç‡

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

GPU     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
æµè§†å›¾  â”‚                                            â”‚
        â”‚                                            â”‚

weight_ â”œâ”€â”€H2D(MHA)â”€â”€â”                   â”œâ”€â”€H2D(L1)â”€â”€â”
h2d_mha â”‚  6.74ms    â”‚evt                â”‚  6.74ms   â”‚
        â”‚            â””â”€â”€â”€â”€â”€â”              â”‚           â”‚
        â”‚                  â”‚              â”‚           â”‚
compute_â”‚              waitâ”‚              â”‚           â”‚
mha     â”‚                  â”œâ”€â”€â”€â”€â”€MHAâ”€â”€â”€â”€â”€â”€â”¤           â”‚
        â”‚                  â”‚   152.42ms   â”‚           â”‚
        â”‚                  â”‚              â”‚           â”‚
        â”‚                  â”‚              â”‚           â”‚
weight_ â”‚                  â”œâ”€â”€H2D(FFN)â”€â”€â”€â”€â”¤           â”‚
h2d_ffn â”‚                  â”‚   13.54ms    â”‚evt        â”‚
        â”‚                  â”‚              â””â”€â”€â”€â”€â”€â”     â”‚
        â”‚                  â”‚                    â”‚     â”‚
compute_â”‚                  â”‚                waitâ”œâ”€FFNâ”€â”¤
ffn     â”‚                  â”‚                    â”‚25.94â”‚
        â”‚                  â”‚                    â”‚     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜
        0ms                                      185ms

æ€»è€—æ—¶: 185ms (ç“¶é¢ˆ: MHAè®¡ç®— 152.42ms + å¼€é”€)
IOéšè—: 100% (6.74+13.54+6.74 = 27.02ms å®Œå…¨è¢«éšè—)
å¹¶è¡Œåº¦: 3æ¡æµåŒæ—¶å·¥ä½œ
```

---

### æ–¹æ³• 2: æ˜¾å¼åŒæ­¥ (å•æµä¸²è¡Œ)

```
æ—¶é—´ â†’  0ms      50ms     100ms    150ms    200ms    250ms
        â”‚        â”‚        â”‚        â”‚        â”‚        â”‚

CPU     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
çº¿ç¨‹    â”‚ é˜»å¡   â”‚  é˜»å¡    â”‚é˜»å¡â”‚  é˜»å¡  â”‚é˜»å¡â”‚      â”‚
        â”‚ 6.74ms â”‚ 152.42ms â”‚13.5â”‚ 25.94  â”‚6.74â”‚      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        205.42ms æ€»è€—æ—¶
        â†‘ CPU ~0.3% åˆ©ç”¨ç‡ (å¤§éƒ¨åˆ†æ—¶é—´åœ¨ç­‰å¾…)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

GPU     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
æµè§†å›¾  â”‚ (å•æµï¼Œæ‰€æœ‰æ“ä½œä¸²è¡Œ)                       â”‚
(é»˜è®¤æµ)â”‚                                            â”‚
        â”‚                                            â”‚
        â”œâ”€â”€H2Dâ”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€MHAâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€H2Dâ”€â”¬â”€â”€FFNâ”€â”€â”¬â”€H2Dâ”€â”
        â”‚ MHA  sync               sync FFN sync    syncâ”‚
        â”‚6.74msâ”‚    152.42ms       â”‚13.5â”‚ 25.94 â”‚6.74 â”‚
        â”‚      â”‚                   â”‚    â”‚       â”‚     â”‚
        â”‚  â†“   â”‚       â†“           â”‚ â†“  â”‚   â†“   â”‚  â†“  â”‚
        â”‚ CPU  â”‚      CPU          â”‚CPU â”‚  CPU  â”‚ CPU â”‚
        â”‚ ç­‰å¾… â”‚      ç­‰å¾…         â”‚ç­‰å¾…â”‚  ç­‰å¾… â”‚ ç­‰å¾…â”‚
        â”‚      â”‚                   â”‚    â”‚       â”‚     â”‚
        â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜
        0ms                                      205.42ms

æ€»è€—æ—¶: 205.42ms (æ‰€æœ‰æ“ä½œä¸²è¡Œç´¯åŠ )
IOéšè—: 0% (27.02ms IO å®Œå…¨æš´éœ²åœ¨å…³é”®è·¯å¾„ä¸Š)
å¹¶è¡Œåº¦: 0 (å•æµï¼Œæ— å¹¶è¡Œ)
```

---

## ä¸‰ã€æ€§èƒ½æŒ‡æ ‡å¯¹æ¯”è¡¨

| æŒ‡æ ‡ | Event å¼‚æ­¥ | æ˜¾å¼åŒæ­¥ | å·®å¼‚ |
|-----|-----------|---------|------|
| **æ€»è€—æ—¶ (å•å±‚)** | **185 ms** | 205.42 ms | **èŠ‚çœ 20.42ms (9.9%)** |
| **80å±‚æ€»è€—æ—¶** | **14.8 s** | 16.4 s | **èŠ‚çœ 1.6s** |
| **CPU å ç”¨æ—¶é—´** | **0.064 ms** | 205.42 ms | **èŠ‚çœ 205.36ms** |
| **CPU åˆ©ç”¨ç‡** | **100%** | ~0.3% | **333å€æå‡** |
| **IO éšè—ç‡** | **100%** | 0% | **å®Œå…¨éšè—** |
| **å¹¶è¡Œæµæ•°é‡** | **3æ¡** | 1æ¡ | **3å€å¹¶è¡Œåº¦** |
| **ååç‡ (tok/s)** | **6.8 tok/s** | 6.1 tok/s | **+11%** |
| **GPU åˆ©ç”¨ç‡** | **~82%** | ~75% | **+7%** |
| **ä»£ç å¤æ‚åº¦** | ä¸­ç­‰ (+30è¡Œ) | ç®€å• | Eventéœ€è¦ç®¡ç† |

---

## å››ã€è¯¦ç»†æ—¶é—´åˆ†è§£

### Event å¼‚æ­¥æ–¹æ³• (æ–¹æ³• 1)

```
æ“ä½œåºåˆ— (GPU è§†è§’):
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[0ms]
â”œâ”€ weight_h2d_mha æµ:
â”‚  â”œâ”€ [0-6.74ms]    cudaMemcpyAsync(MHA weights) â”€â”€â”€â”€â”€â”
â”‚  â””â”€ [6.74ms]      cudaEventRecord(mha_h2d_evt)      â”‚
â”‚                                                      â”‚
â”œâ”€ compute_mha æµ:                                    â”‚
â”‚  â”œâ”€ [0ms]         cudaStreamWaitEvent(mha_h2d_evt)  â”‚
â”‚  â”‚                â†“ ç­‰å¾… mha_h2d_evt å°±ç»ª            â”‚
â”‚  â”œâ”€ [6.74ms]      mha_h2d_evt å°±ç»ª! â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â””â”€ [6.74-159.16] cudaLaunchKernel(SDPA) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                     â”‚
â”œâ”€ weight_h2d_ffn æµ:                                â”‚
â”‚  â”œâ”€ [6.74-20.28]  cudaMemcpyAsync(FFN weights) â”€â”€â” â”‚
â”‚  â””â”€ [20.28ms]     cudaEventRecord(ffn_h2d_evt)   â”‚ â”‚
â”‚                                                   â”‚ â”‚
â”œâ”€ compute_ffn æµ:                                 â”‚ â”‚
â”‚  â”œâ”€ [20.28ms]     cudaStreamWaitEvent(ffn_evt)   â”‚ â”‚
â”‚  â”‚                â†“ ç­‰å¾… ffn_h2d_evt å°±ç»ª         â”‚ â”‚
â”‚  â”œâ”€ [20.28ms]     ffn_h2d_evt å°±ç»ª! â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”œâ”€ [159.16ms]    MHA å®Œæˆ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â””â”€ [159.16-185]  cudaLaunchKernel(FFN) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                    â”‚
â”œâ”€ weight_h2d_mha æµ: (å¤ç”¨ï¼Œé¢„å–ä¸‹ä¸€å±‚)            â”‚
â”‚  â””â”€ [159.16-166]  cudaMemcpyAsync(Layer1 MHA) â”€â”€â” â”‚
â”‚                                                  â”‚ â”‚
[185ms]                                            â”‚ â”‚
â””â”€ FFN å®Œæˆ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
   Layer1 æƒé‡å·²é¢„å– â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å…³é”®è·¯å¾„: MHAè®¡ç®— (152.42ms) + FFNè®¡ç®— (25.94ms) + å¼€é”€ (~6.64ms)
IOæ“ä½œ: å…¨éƒ¨éšè—åœ¨è®¡ç®—çª—å£å†… (å¹¶è¡Œæ‰§è¡Œ)
```

---

### æ˜¾å¼åŒæ­¥æ–¹æ³• (æ–¹æ³• 2)

```
æ“ä½œåºåˆ— (GPU + CPU è§†è§’):
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[0ms]
â”œâ”€ é»˜è®¤æµ (å•æµï¼Œä¸²è¡Œ):
â”‚
â”‚  â”œâ”€ [0-6.74ms]      cudaMemcpy(MHA weights, blocking)
â”‚  â”‚                  â†“ CPU é˜»å¡ç­‰å¾… 6.74ms
â”‚  â”‚
â”‚  â”œâ”€ [6.74-6.75ms]   cudaLaunchKernel(SDPA)
â”‚  â”œâ”€ [6.75-159.17]   SDPA æ‰§è¡Œ
â”‚  â”‚                  â†“ CPU é˜»å¡ç­‰å¾… 152.42ms (synchronize)
â”‚  â”‚
â”‚  â”œâ”€ [159.17-172.71] cudaMemcpy(FFN weights, blocking)
â”‚  â”‚                  â†“ CPU é˜»å¡ç­‰å¾… 13.54ms
â”‚  â”‚
â”‚  â”œâ”€ [172.71-172.72] cudaLaunchKernel(FFN)
â”‚  â”œâ”€ [172.72-198.66] FFN æ‰§è¡Œ
â”‚  â”‚                  â†“ CPU é˜»å¡ç­‰å¾… 25.94ms (synchronize)
â”‚  â”‚
â”‚  â”œâ”€ [198.66-205.40] cudaMemcpy(Layer1 weights, blocking)
â”‚  â”‚                  â†“ CPU é˜»å¡ç­‰å¾… 6.74ms
â”‚  â”‚
[205.42ms]
â””â”€ Layer 0 å®Œæˆï¼ŒLayer1 æƒé‡å·²åŠ è½½

å…³é”®è·¯å¾„: æ‰€æœ‰æ“ä½œä¸²è¡Œç´¯åŠ 
IOæ“ä½œ: å®Œå…¨æš´éœ²åœ¨å…³é”®è·¯å¾„ä¸Š (æ— å¹¶è¡Œ)
CPU: å¤§éƒ¨åˆ†æ—¶é—´é˜»å¡åœ¨ synchronize()
```

---

## äº”ã€ä¼˜åŠ£åŠ¿å¯¹æ¯”

### Event å¼‚æ­¥æ–¹æ³• (æ–¹æ³• 1)

#### âœ… ä¼˜åŠ¿

1. **æ€§èƒ½ä¼˜ç§€**
   - å•å±‚èŠ‚çœ 20.42ms (9.9%)
   - 80å±‚èŠ‚çœ 1.6ç§’
   - IO å®Œå…¨éšè— (100% é‡å )

2. **CPU æ•ˆç‡é«˜**
   - CPU ä»…è€—æ—¶ 0.064ms
   - CPU åˆ©ç”¨ç‡ 100%
   - å¯åŒæ—¶å¤„ç†å…¶ä»–ä»»åŠ¡ (æ•°æ®åŠ è½½ã€é¢„å¤„ç†ç­‰)

3. **æ‰©å±•æ€§å¥½**
   - æ”¯æŒå¤šå±‚æµæ°´çº¿
   - å¯å¢åŠ æ›´å¤šå¹¶è¡Œæµ
   - æ˜“äºæ·»åŠ é¢„å–é€»è¾‘

4. **GPU åˆ©ç”¨ç‡é«˜**
   - 3æ¡æµå¹¶è¡Œå·¥ä½œ
   - DMA Engine ä¸ SM åŒæ—¶è¿è¡Œ
   - PCIe å¸¦å®½å……åˆ†åˆ©ç”¨

#### âŒ åŠ£åŠ¿

1. **ä»£ç å¤æ‚**
   - éœ€è¦ç®¡ç†å¤šä¸ªæµ
   - Event ç”Ÿå‘½å‘¨æœŸç®¡ç†
   - è°ƒè¯•å›°éš¾ (å¼‚æ­¥é—®é¢˜éš¾è¿½è¸ª)

2. **éœ€è¦ç†è§£ CUDA**
   - éœ€è¦ç†è§£æµ/äº‹ä»¶æœºåˆ¶
   - éœ€è¦ç†è§£å¼‚æ­¥ç¼–ç¨‹
   - é”™è¯¯ä½¿ç”¨å¯èƒ½å¯¼è‡´æ•°æ®ç«äº‰

3. **å†…å­˜å ç”¨ç•¥é«˜**
   - æ¯æ¡æµéœ€è¦å°‘é‡å†…å­˜ (~100KB)
   - Event å¯¹è±¡å¼€é”€ (~100B/ä¸ª)

---

### æ˜¾å¼åŒæ­¥æ–¹æ³• (æ–¹æ³• 2)

#### âœ… ä¼˜åŠ¿

1. **ä»£ç ç®€å•**
   - æ— éœ€ç®¡ç†æµ
   - æ— éœ€ç®¡ç† Event
   - æ˜“äºç†è§£å’Œè°ƒè¯•

2. **æ­£ç¡®æ€§å®¹æ˜“ä¿è¯**
   - ä¸²è¡Œæ‰§è¡Œï¼Œæ— ç«æ€
   - synchronize() ä¿è¯å®Œæˆ
   - ä¸ä¼šå‡ºç°å¼‚æ­¥é”™è¯¯

3. **å†…å­˜å ç”¨ä½**
   - ä»…ä½¿ç”¨é»˜è®¤æµ
   - æ— é¢å¤– Event å¯¹è±¡

#### âŒ åŠ£åŠ¿

1. **æ€§èƒ½å·®**
   - å•å±‚æ…¢ 20.42ms (9.9%)
   - 80å±‚æ…¢ 1.6ç§’
   - IO æ— æ³•éšè—

2. **CPU æµªè´¹**
   - CPU é˜»å¡ 205.42ms/å±‚
   - CPU åˆ©ç”¨ç‡ <1%
   - æ— æ³•å¤„ç†å…¶ä»–ä»»åŠ¡

3. **GPU åˆ©ç”¨ç‡ä½**
   - å•æµï¼Œæ— å¹¶è¡Œ
   - DMA ä¸è®¡ç®—ä¸²è¡Œ
   - PCIe ç©ºé—²æ—¶é—´é•¿

4. **æ‰©å±•æ€§å·®**
   - æ— æ³•å®ç°æµæ°´çº¿
   - æ— æ³•é¢„å–
   - å¤šå±‚æ€§èƒ½çº¿æ€§ç´¯åŠ 

---

## å…­ã€å®é™…æ¡ˆä¾‹å¯¹æ¯”

### åœºæ™¯: Llama 3.1-70B Decode (80å±‚)

#### ä½¿ç”¨ Event å¼‚æ­¥ (å½“å‰å®ç°)

```python
# å•å±‚æ—¶é—´: 185ms
# 80å±‚æ€»æ—¶é—´: 14.8s
# ååç‡: 6.8 tok/s

# CPU å¯åœ¨ GPU è®¡ç®—æ—¶:
#  - åŠ è½½ä¸‹ä¸€æ‰¹æƒé‡
#  - é¢„å¤„ç†è¾“å…¥ token
#  - æ›´æ–° KV cache å…ƒæ•°æ®
#  - å¤„ç†ç”¨æˆ·è¯·æ±‚
```

#### ä½¿ç”¨æ˜¾å¼åŒæ­¥

```python
# å•å±‚æ—¶é—´: 205.42ms
# 80å±‚æ€»æ—¶é—´: 16.4s
# ååç‡: 6.1 tok/s

# CPU é˜»å¡æ—¶é—´:
#  - å•å±‚: 205.42ms
#  - 80å±‚: 16.4s
#  - æœŸé—´ CPU å®Œå…¨ç©ºé—² (99.7% æ—¶é—´åœ¨ç­‰å¾…)
```

#### æ€§èƒ½å·®å¼‚

```
Event å¼‚æ­¥ vs æ˜¾å¼åŒæ­¥:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
å• token å»¶è¿Ÿ:  14.8s  vs  16.4s  (-1.6s)
ååç‡:         6.8    vs  6.1    (+11%)
CPU åˆ©ç”¨ç‡:     100%   vs  0.3%   (+333x)
GPU åˆ©ç”¨ç‡:     82%    vs  75%    (+7%)

æ¯å°æ—¶ç”Ÿæˆ:
  Event å¼‚æ­¥:   24,480 tokens
  æ˜¾å¼åŒæ­¥:     21,960 tokens
  å·®å¼‚:         +2,520 tokens (+11%)
```

---

## ä¸ƒã€ä½•æ—¶ä½¿ç”¨å“ªç§æ–¹æ³•ï¼Ÿ

### ä½¿ç”¨ Event å¼‚æ­¥ (æ¨è) âœ…

**é€‚ç”¨åœºæ™¯**:
1. âœ… ç”Ÿäº§ç¯å¢ƒ (è¿½æ±‚æ€§èƒ½)
2. âœ… å¤§æ¨¡å‹æ¨ç† (IO/è®¡ç®—é‡å å…³é”®)
3. âœ… å¤šå±‚æµæ°´çº¿
4. âœ… éœ€è¦é«˜ååç‡
5. âœ… CPU éœ€è¦å¤„ç†å…¶ä»–ä»»åŠ¡

**å‰ææ¡ä»¶**:
- å›¢é˜Ÿç†Ÿæ‚‰ CUDA å¼‚æ­¥ç¼–ç¨‹
- æœ‰å®Œå–„çš„è°ƒè¯•å·¥å…·
- æ€§èƒ½æå‡ >5%

---

### ä½¿ç”¨æ˜¾å¼åŒæ­¥ âŒ

**é€‚ç”¨åœºæ™¯**:
1. âš ï¸ åŸå‹éªŒè¯ (å¿«é€Ÿæµ‹è¯•)
2. âš ï¸ è°ƒè¯•é˜¶æ®µ (æ’æŸ¥é”™è¯¯)
3. âš ï¸ å•å±‚æ¨ç† (æ— æµæ°´çº¿)
4. âš ï¸ æ€§èƒ½ä¸æ•æ„Ÿçš„åº”ç”¨

**å‰ææ¡ä»¶**:
- ä¸å…³å¿ƒæ€§èƒ½ (å¯æ¥å— 10% æ€§èƒ½æŸå¤±)
- CPU èµ„æºå……è¶³ (å¯æµªè´¹)
- ä»£ç ç®€å•ä¼˜å…ˆ

---

## å…«ã€ä»åŒæ­¥è¿ç§»åˆ°å¼‚æ­¥çš„å»ºè®®

### æ¸è¿›å¼è¿ç§»è·¯å¾„

#### é˜¶æ®µ 1: å¼•å…¥å¤šæµ (ä¸æ”¹å˜é€»è¾‘)

```python
# åˆ›å»ºæµ
h2d_stream = torch.cuda.Stream()
compute_stream = torch.cuda.Stream()

# æ›¿æ¢é»˜è®¤æµ
with torch.cuda.stream(h2d_stream):
    weights_gpu = weights_cpu.to('cuda', non_blocking=True)

torch.cuda.synchronize()  # ä¿ç•™åŒæ­¥ï¼Œä¿è¯æ­£ç¡®æ€§

with torch.cuda.stream(compute_stream):
    out = model(weights_gpu)

torch.cuda.synchronize()
```

#### é˜¶æ®µ 2: å¼•å…¥ Event (æ¶ˆé™¤ synchronize)

```python
h2d_stream = torch.cuda.Stream()
compute_stream = torch.cuda.Stream()

with torch.cuda.stream(h2d_stream):
    weights_gpu = weights_cpu.to('cuda', non_blocking=True)

evt = torch.cuda.Event()
evt.record(h2d_stream)
compute_stream.wait_event(evt)  # æ›¿æ¢ synchronize

with torch.cuda.stream(compute_stream):
    out = model(weights_gpu)

# ç§»é™¤æœ€åçš„ synchronize (è®© GPU åå°æ‰§è¡Œ)
```

#### é˜¶æ®µ 3: å®ç°æµæ°´çº¿ (å¤šå±‚é‡å )

```python
# é¢„å– Layer 1
with torch.cuda.stream(h2d_stream):
    layer1_weights = layer1_cpu.to('cuda', non_blocking=True)

evt_l0 = torch.cuda.Event()
evt_l0.record(h2d_stream)

# è®¡ç®— Layer 0 (ä¸ Layer 1 H2D å¹¶è¡Œ)
compute_stream.wait_event(evt_l0)
with torch.cuda.stream(compute_stream):
    out_l0 = model_l0(layer0_weights)
```

---

## ä¹ã€è°ƒè¯•æŠ€å·§

### Event å¼‚æ­¥æ–¹æ³•çš„è°ƒè¯•

```python
# æŠ€å·§ 1: ä¸´æ—¶å¯ç”¨åŒæ­¥ (æ’æŸ¥æ•°æ®ç«äº‰)
os.environ['CUDA_LAUNCH_BLOCKING'] = '1'
# â†‘ å¼ºåˆ¶æ‰€æœ‰æ“ä½œåŒæ­¥ï¼Œæ€§èƒ½å·®ä½†æ˜“è°ƒè¯•

# æŠ€å·§ 2: æ£€æŸ¥ Event å®ŒæˆçŠ¶æ€
if not evt.query():
    print(f"WARNING: Event not ready! Possible race condition.")

# æŠ€å·§ 3: è®°å½•æ—¶é—´æˆ³
evt.record(stream)
evt.synchronize()
elapsed = evt.elapsed_time(start_evt)  # ç²¾ç¡®æµ‹é‡
print(f"H2D time: {elapsed:.2f}ms")

# æŠ€å·§ 4: ä½¿ç”¨ CUDA Graph (é«˜çº§)
# å½•åˆ¶æ•´ä¸ªæµæ°´çº¿ä¸º Graphï¼Œå¤ç°é—®é¢˜æ›´å®¹æ˜“
```

---

## åã€æ€»ç»“

| æ–¹é¢ | Event å¼‚æ­¥ | æ˜¾å¼åŒæ­¥ | æ¨è |
|-----|-----------|---------|------|
| **æ€§èƒ½** | â­â­â­â­â­ | â­â­â­ | Event å¼‚æ­¥ |
| **ç®€å•æ€§** | â­â­â­ | â­â­â­â­â­ | æ˜¾å¼åŒæ­¥ |
| **CPU æ•ˆç‡** | â­â­â­â­â­ | â­ | Event å¼‚æ­¥ |
| **æ‰©å±•æ€§** | â­â­â­â­â­ | â­â­ | Event å¼‚æ­¥ |
| **è°ƒè¯•éš¾åº¦** | â­â­ | â­â­â­â­â­ | æ˜¾å¼åŒæ­¥ |
| **ç”Ÿäº§å°±ç»ª** | â­â­â­â­â­ | â­â­ | Event å¼‚æ­¥ |

**æœ€ç»ˆå»ºè®®**:
- ğŸš€ **ç”Ÿäº§ç¯å¢ƒ**: å¿…é¡»ä½¿ç”¨ Event å¼‚æ­¥ (æ€§èƒ½æå‡ 11%)
- ğŸ”§ **å¼€å‘/è°ƒè¯•**: å¯ä¸´æ—¶ç”¨æ˜¾å¼åŒæ­¥ (æ’æŸ¥é—®é¢˜)
- ğŸ“š **å­¦ä¹ è·¯å¾„**: åŒæ­¥ â†’ å¤šæµ â†’ Event â†’ æµæ°´çº¿

ä½ çš„å½“å‰å®ç° (Event å¼‚æ­¥) æ˜¯æ­£ç¡®çš„é€‰æ‹©ï¼ä¿æŒç°çŠ¶ï¼Œç»§ç»­ä¼˜åŒ–æµæ°´çº¿æ·±åº¦å’Œé¢„å–ç­–ç•¥ã€‚
