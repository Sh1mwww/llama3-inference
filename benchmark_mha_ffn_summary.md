# 70B模型 MHA/FFN 分离性能测试结果

## 测试环境
- GPU: NVIDIA GeForce RTX 5080 (15.46 GB)
- 模型: Llama 3.1-70B
- 测试时禁用了KV cache mirroring以测量纯计算时间

## 权重大小
- **MHA权重**: 0.281 GB (150,994,944 参数)
  - wq, wk, wv, wo
- **FFN权重**: 0.562 GB (301,989,888 参数)
  - w1, w2, w3 (hidden_dim=12288)
- **总计**: 0.844 GB

## 计算时间 (纯计算，无IO)

### Prefill阶段 (2048 tokens)

| 组件 | 平均时间 | 占比 | 最小 | 最大 | 标准差 |
|------|---------|------|------|------|--------|
| **MHA** | **152.42 ms** | **85.5%** | 142.67 ms | 186.72 ms | 12.77 ms |
| **FFN** | **25.94 ms** | **14.5%** | 25.75 ms | 26.11 ms | 0.13 ms |
| **总计** | **178.36 ms** | **100%** | - | - | - |

**关键发现**:
- ⚠️ **MHA占据了Prefill计算的85.5%** - 是主要计算瓶颈
- FFN计算相对很快，只占14.5%
- MHA的标准差较大(12.77ms)，可能是KV cache操作导致

### Decode阶段 (1 token)

| 组件 | 平均时间 | 占比 | 最小 | 最大 | 标准差 |
|------|---------|------|------|------|--------|
| **MHA** | **0.68 ms** | **30.3%** | 0.65 ms | 0.91 ms | 0.04 ms |
| **FFN** | **1.57 ms** | **69.7%** | 1.57 ms | 1.58 ms | 0.00 ms |
| **总计** | **2.26 ms** | **100%** | - | - | - |

**关键发现**:
- 🔄 **FFN占据了Decode计算的69.7%** - 占比反转！
- Decode时MHA很快(只需0.68ms)，因为只处理1个token
- FFN仍需处理完整的FFN计算，所以成为瓶颈

### Prefill vs Decode 对比

|  | MHA | FFN | 总计 |
|---|-----|-----|------|
| **Prefill** | 152.42 ms | 25.94 ms | 178.36 ms |
| **Decode** | 0.68 ms | 1.57 ms | 2.26 ms |
| **加速比** | **224x** | **16.5x** | **79x** |

- MHA在Decode时加速最明显 (224x)
- FFN加速相对较小 (16.5x)

## IO时间

### Pin->GPU 传输时间

| 组件 | 权重大小 | 平均时间 | 带宽 |
|------|----------|---------|------|
| **MHA** | 0.281 GB | **6.74 ms** | 41.74 GB/s |
| **FFN** | 0.562 GB | **13.54 ms** | 41.56 GB/s |
| **总计** | 0.844 GB | **20.28 ms** | ~41.6 GB/s |

**关键发现**:
- 带宽一致性很好 (~41.6 GB/s)
- FFN传输时间是MHA的2倍 (因为权重是2倍大)

### SSD->Pin 读取时间

| 组件 | 权重大小 | 平均时间 | 带宽 | 标准差 |
|------|----------|---------|------|--------|
| **MHA** | 0.281 GB | **64.23 ms** | 4.38 GB/s | 4.11 ms |
| **FFN** | 0.562 GB | **129.01 ms** | 4.36 GB/s | 9.39 ms |
| **总计** | 0.844 GB | **193.24 ms** | ~4.4 GB/s | - |

**关键发现**:
- SSD带宽一致 (~4.4 GB/s)
- FFN读取时间是MHA的2倍 (权重2倍大)
- 标准差较大，SSD性能波动明显

## 重叠可行性分析

### Prefill阶段 (2048 tokens)

#### 串行执行
```
总时间: 391.88 ms
├─ MHA计算:    152.42 ms (38.9%) ← 最大瓶颈
├─ FFN计算:     25.94 ms ( 6.6%)
├─ MHA Pin->GPU: 6.74 ms ( 1.7%)
├─ FFN Pin->GPU:13.54 ms ( 3.5%)
├─ MHA SSD->Pin:64.23 ms (16.4%)
└─ FFN SSD->Pin:129.01 ms (32.9%) ← 第二大瓶颈
```

#### 层内流水线分析

**MHA阶段**:
- 计算时间: 152.42 ms
- IO时间 (Pin->GPU + SSD->Pin): 70.97 ms
- **瓶颈**: max(152.42, 70.97) = **152.42 ms** (计算)
- ✅ **MHA计算可以完全隐藏MHA的IO**

**FFN阶段**:
- 计算时间: 25.94 ms
- IO时间 (Pin->GPU + SSD->Pin): 142.54 ms
- **瓶颈**: max(25.94, 142.54) = **142.54 ms** (IO)
- ❌ **FFN计算无法隐藏FFN的IO，需要额外等待 116.60 ms**

#### 理想流水线
```
理想时间: 294.96 ms
理论加速比: 1.33x

流水线结构:
MHA: [====计算152.42ms====] (隐藏IO 70.97ms)
FFN:                       [====IO 142.54ms====] (计算25.94ms被隐藏)
```

### Decode阶段 (1 token)

#### 串行执行
```
总时间: 215.77 ms
├─ MHA计算:      0.68 ms ( 0.3%)
├─ FFN计算:      1.57 ms ( 0.7%)
├─ MHA Pin->GPU: 6.74 ms ( 3.1%)
├─ FFN Pin->GPU:13.54 ms ( 6.3%)
├─ MHA SSD->Pin:64.23 ms (29.8%) ← 第二大瓶颈
└─ FFN SSD->Pin:129.01 ms (59.8%) ← 最大瓶颈
```

#### 层内流水线分析

**MHA阶段**:
- 计算时间: 0.68 ms
- IO时间: 70.97 ms
- **瓶颈**: max(0.68, 70.97) = **70.97 ms** (IO)
- ❌ **MHA计算无法隐藏IO，需要额外等待 70.28 ms**

**FFN阶段**:
- 计算时间: 1.57 ms
- IO时间: 142.54 ms
- **瓶颈**: max(1.57, 142.54) = **142.54 ms** (IO)
- ❌ **FFN计算无法隐藏IO，需要额外等待 140.97 ms**

#### 理想流水线
```
理想时间: 213.51 ms
理论加速比: 1.01x (几乎没有加速！)

流水线结构:
MHA: [IO 70.97ms]  (计算0.68ms被隐藏)
FFN:              [====IO 142.54ms====] (计算1.57ms被隐藏)
```

#### 预取距离建议
- **MHA**: 需要提前 **104层** (!)
- **FFN**: 需要提前 **91层** (!)
- ⚠️ **这超过了模型总层数80层** - 说明Decode阶段SSD读取是绝对瓶颈

## 关键洞察

### 1. 计算特性对比

| 特性 | MHA | FFN |
|------|-----|-----|
| **Prefill计算占比** | 85.5% (主导) | 14.5% |
| **Decode计算占比** | 30.3% | 69.7% (主导) |
| **权重大小** | 0.281 GB (33%) | 0.562 GB (67%) |
| **计算密度** | 高 (Prefill) | 低 (相对权重) |

### 2. IO vs 计算平衡

#### Prefill阶段
- ✅ **MHA**: 计算密集型 (152.42ms 计算 >> 70.97ms IO)
  - 可以有效隐藏IO
  - 流水线效果好
- ❌ **FFN**: IO密集型 (25.94ms 计算 << 142.54ms IO)
  - 计算太快，无法隐藏IO
  - 需要额外等待116.60ms
  - **FFN的SSD读取成为Prefill的瓶颈**

#### Decode阶段
- ❌ **MHA & FFN**: 都是IO密集型
  - 计算极快 (MHA 0.68ms, FFN 1.57ms)
  - 完全无法隐藏IO (70.97ms + 142.54ms)
  - **SSD读取是绝对瓶颈**

### 3. 优化策略建议

#### 短期优化 (针对现有硬件)
1. **Prefill阶段**: 
   - 重点优化FFN的SSD读取
   - 考虑FFN权重压缩 (67%的权重但只14.5%的计算)
   - 提前2层预取FFN权重 (129ms / 152ms ≈ 1层)

2. **Decode阶段**:
   - 目前流水线几乎无效 (1.01x加速)
   - **强烈建议使用系统内存作为二级缓存**
   - 或增加GPU内存以缓存更多层

#### 长期优化
1. **升级SSD速度**: 
   - 当前: 4.4 GB/s
   - 目标: >20 GB/s (使NVMe Gen4/Gen5)
   - 这样Decode阶段也能有效流水线

2. **权重重组**: 
   - 将FFN权重存储优化 (可能的量化/剪枝)
   - FFN占67%权重但Prefill只14.5%计算，压缩潜力大

3. **异构存储**:
   - 高频访问的MHA权重放在更快的存储
   - FFN权重可以用稍慢的存储

### 4. 与之前整层测试的对比

| 指标 | 整层测试 | MHA+FFN分离 | 差异 |
|------|---------|-------------|------|
| **Prefill计算** | 172.92 ms | 178.36 ms | +5.44 ms (3%) |
| **Decode计算** | 2.45 ms | 2.26 ms | -0.19 ms (8%) |
| **Pin->GPU** | 20.32 ms | 20.28 ms | -0.04 ms |
| **SSD->Pin** | 189.79 ms | 193.24 ms | +3.45 ms (2%) |

差异很小，说明测试的一致性很好！

## 结论

1. **Prefill瓶颈**: MHA计算(85.5%) + FFN IO(等待116.60ms)
2. **Decode瓶颈**: 完全是IO瓶颈 (SSD读取占99%时间)
3. **流水线效果**: 
   - Prefill: 1.33x (有限)
   - Decode: 1.01x (几乎无效)
4. **优化方向**: 
   - 提升SSD速度 (最关键)
   - 使用DRAM作为二级缓存
   - 考虑FFN权重压缩
